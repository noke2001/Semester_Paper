Bootstrap: docker
From: ubuntu:22.04

%environment
    export PYTHONUNBUFFERED=1
    export PATH=/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin
    export LC_ALL=C.UTF-8
    export LANG=C.UTF-8

%post
    # 1. Update and install core system dependencies
    apt-get update
    apt-get -y upgrade
    
    export DEBIAN_FRONTEND=noninteractive 

    # System Dependencies:
    # - libomp-dev: REQUIRED for LightGBM/XGBoost/GPBoost
    # - libopenblas/lzma/bz2/icu: REQUIRED for R and rpy2
    # - r-cran-devtools: REQUIRED for drf installation (it uses R devtools to build)
    apt-get install -y \
        python3-pip \
        python3-dev \
        build-essential \
        swig \
        wget \
        git \
        uidmap \
        ca-certificates \
        libopenblas-dev \
        liblzma-dev \
        libbz2-dev \
        libicu-dev \
        gfortran \
        libomp-dev \
        r-base \
        r-base-dev \
        r-cran-devtools

    # Ensure python command points to python3
    update-alternatives --install /usr/bin/python python /usr/bin/python3 1

    # 2. Upgrade pip
    /usr/bin/python3 -m pip install --upgrade pip

    # 3. Install Numpy FIRST (Critical Constraint)
    # We pin numpy < 2.0.0 to avoid binary incompatibility with scikit-learn-extra
    /usr/bin/python3 -m pip install --no-cache-dir "numpy<2.0.0"

    # 4. Install rpy2 PRE-REQUISITES
    # We install cffi and rpy2 here. They MUST be installed before drf tries to build.
    /usr/bin/python3 -m pip install --no-cache-dir cffi rpy2

    # 5. Install DRF with NO BUILD ISOLATION
    # We use --no-build-isolation so that the build process can "see" the rpy2 
    # we installed in step 4. Without this, pip creates an empty build env and fails.
    /usr/bin/python3 -m pip install --no-cache-dir --no-build-isolation \
        "git+https://github.com/lorismichel/drf.git@87247a7803497d75f0bc61c95ace9310f56a3bad#egg=drf&subdirectory=python-package"

    # 6. Install other Git dependencies
    /usr/bin/python3 -m pip install --no-cache-dir \
        "git+https://github.com/PriorLabs/tabpfn-extensions@d44606e35f89e18b6bc4c4a2eef2f46918c4302e#egg=tabpfn_extensions"

    # 7. Install General Dependencies
    /usr/bin/python3 -m pip install --no-cache-dir \
        smac \
        openml \
        torch \
        scikit-learn \
        scikit-learn-extra \
        pandas \
        scipy \
        matplotlib \
        seaborn \
        alembic \
        asttokens \
        cloudpickle \
        colorlog \
        colour \
        contourpy \
        cycler \
        decorator \
        einops \
        engression \
        executing \
        fonttools \
        fsspec \
        future \
        gower \
        gpboost \
        greenlet \
        huggingface-hub \
        hyperopt \
        idna \
        ipython \
        jedi \
        Jinja2 \
        kditransform \
        kiwisolver \
        lightgbm \
        lightgbmlss \
        Mako \
        MarkupSafe \
        matplotlib-inline \
        mizani \
        mpmath \
        networkx \
        opt_einsum \
        optuna \
        packaging \
        parso \
        patsy \
        pexpect \
        pillow \
        plotnine \
        progressbar2 \
        properscoring \
        prompt_toolkit \
        ptyprocess \
        pure_eval \
        py4j \
        pygam \
        Pygments \
        pyparsing \
        pyro-api \
        pyro-ppl \
        PyYAML \
        requests \
        rtdl_revisiting_models \
        shap \
        shapiq \
        slicer \
        SQLAlchemy \
        stack-data \
        statsmodels \
        sympy \
        tabpfn \
        tqdm \
        traitlets \
        triton \
        typing_extensions \
        urllib3 \
        wcwidth \
        Bottleneck \
        certifi \
        distlib \
        filelock \
        joblib \
        llvmlite \
        numba \
        numexpr \
        platformdirs \
        pycparser \
        pynndescent \
        python-dateutil \
        pytz \
        simplegeneric \
        six \
        threadpoolctl \
        tzdata \
        tzlocal \
        umap-learn \
        virtualenv

    # 8. Clean up
    apt-get clean
    rm -rf /var/lib/apt/lists/*